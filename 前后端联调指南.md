# 前后端联调指南

## 一、环境检查清单

### ✅ 已完成的配置

1. **前端配置**
   - ✅ API地址已设置：`http://localhost:3000`
   - ✅ 位置：`fonted/utils/config.js`
   - ✅ 所有API路径已正确配置

2. **后端配置**
   - ✅ 服务端口：`3000`
   - ✅ CORS跨域已配置（允许所有源）
   - ✅ 位置：`backed/config/config.yaml`

### ⚠️ 待完成的配置

1. **数据库配置**
   - 需要执行：`backed/init.sql`
   - 数据库名：`SM`
   - 默认账号：
     - 用户名：`sm_admin`
     - 密码：`123456`

---

## 二、启动步骤

### 步骤 1：初始化数据库

```sql
-- 1. 连接到MySQL（使用root或其他管理员账号）
mysql -u root -p

-- 2. 执行初始化脚本
source d:/基于国密加密的网上看诊系统/backed/init.sql

-- 3. 验证数据库创建成功
USE SM;
SHOW TABLES;

-- 应该看到以下8个表：
-- SM_user
-- SM_doctor_application
-- SM_login_log
-- SM_consultation
-- SM_consultation_message
-- SM_medical_record
-- SM_record_access_log
-- SM_notification
```

**默认管理员账号**：
- 用户名：`admin`
- 密码：`Admin123!@#`（注意：密码已经过SM3加密存储）

### 步骤 2：启动后端服务

```powershell
# 进入后端目录
cd d:/基于国密加密的网上看诊系统/backed

# 启动服务
go run cmd/main.go
```

**预期输出**：
```
Crypto initialized successfully
Database connected successfully
Server is running on :3000
Environment: debug
Database: sm_admin@localhost:3306/SM
```

### 步骤 3：启动前端项目

```powershell
# 进入前端目录
cd d:/基于国密加密的网上看诊系统/fonted

# 启动开发服务器（根据你的前端框架）
# 如果是 HBuilderX，直接运行到浏览器
# 如果是 uni-app CLI，执行：
npm run dev:h5
```

---

## 三、联调测试

### 测试 1：用户注册

**前端操作**：
1. 打开注册页面
2. 填写注册信息：
   - 用户名：`testuser01`
   - 密码：`Test123!@#`
   - 邮箱：`test@example.com`
   - 手机号：`13800138001`
   - 验证码：`123456`（当前为模拟验证）

**后端日志检查**：
```
[GIN] POST /api/user/register
Status: 200
Response: {"code":200,"message":"注册成功",...}
```

### 测试 2：用户登录

**前端操作**：
1. 打开登录页面
2. 填写登录信息：
   - 用户名：`admin`
   - 密码：`Admin123!@#`

**验证点**：
- ✅ 能否成功登录
- ✅ Token是否正确返回
- ✅ 用户信息是否正确
- ✅ Token是否保存到本地存储

**后端日志检查**：
```
[GIN] POST /api/user/login
Status: 200
Response: {"code":200,"message":"登录成功","data":{"token":"..."}}
```

### 测试 3：获取用户信息

**前端操作**：
1. 登录成功后
2. 自动调用 `/api/user/info` 接口

**验证点**：
- ✅ 请求头是否携带 `Authorization: Bearer <token>`
- ✅ 是否返回完整用户信息
- ✅ 敏感信息（邮箱、手机号）是否正确解密

### 测试 4：获取医生列表

**前端操作**：
1. 进入"找医生"页面
2. 查看医生列表

**API**：`GET /api/user/doctors`

**验证点**：
- ✅ 是否返回医生列表
- ✅ 分页是否正常
- ✅ 科室筛选是否有效

### 测试 5：申请成为医生

**前端操作**：
1. 登录普通用户账号
2. 进入"申请医生认证"页面
3. 填写医生信息并上传证书

**API**：`POST /api/user/apply-doctor`

**验证点**：
- ✅ 文件上传是否成功
- ✅ 申请是否提交成功
- ✅ 敏感信息是否加密

### 测试 6：管理员审核医生申请

**前端操作**：
1. 使用管理员账号登录（`admin`）
2. 进入管理后台
3. 查看待审核的医生申请
4. 审核通过或拒绝

**API**：
- `GET /api/user/admin/doctor-applications`
- `PUT /api/user/admin/review-doctor`

---

## 四、常见问题排查

### 问题 1：前端请求失败（网络错误）

**症状**：
```
Network Error
ERR_CONNECTION_REFUSED
```

**排查步骤**：
1. 检查后端服务是否启动：访问 `http://localhost:3000`
2. 检查防火墙是否拦截
3. 检查前端API地址配置是否正确

### 问题 2：CORS跨域错误

**症状**：
```
Access to XMLHttpRequest blocked by CORS policy
```

**解决方案**：
- 后端CORS中间件已配置，正常情况不应出现此问题
- 如果出现，检查 `backed/internal/middleware/auth.go` 的 CORS 配置

### 问题 3：401 未授权

**症状**：
```json
{"code":401,"message":"请先登录"}
```

**排查步骤**：
1. 检查是否携带 Token
2. 检查 Token 格式：`Bearer <token>`
3. 检查 Token 是否过期（默认2小时）
4. 检查请求头：`Authorization`

### 问题 4：数据库连接失败

**症状**：
```
Failed to init database: Error 1045: Access denied
```

**解决方案**：
1. 修改 `backed/config/config.yaml` 中的数据库配置
2. 确保数据库用户名和密码正确
3. 确保数据库 `SM` 已创建

### 问题 5：加密数据解密失败

**症状**：
- 邮箱、手机号显示乱码
- 解密失败错误

**排查步骤**：
1. 检查 SM4 密钥配置是否正确
2. 检查加密和解密使用的密钥是否一致
3. 查看后端日志中的错误信息

---

## 五、调试技巧

### 前端调试

1. **查看网络请求**
   ```javascript
   // 在浏览器控制台 Network 标签查看
   - Request URL
   - Request Headers (是否携带Token)
   - Response (返回数据是否正确)
   ```

2. **查看本地存储**
   ```javascript
   // 在浏览器控制台 Application -> Local Storage
   console.log(uni.getStorageSync('token'))
   console.log(uni.getStorageSync('userInfo'))
   ```

3. **国密加密调试**
   ```javascript
   // 在 fonted/utils/crypto.js 中添加日志
   console.log('SM3 Hash:', hash)
   console.log('SM4 Encrypted:', encrypted)
   ```

### 后端调试

1. **查看日志输出**
   - 所有请求都会打印到控制台
   - 格式：`[GIN] METHOD PATH`

2. **数据库查询调试**
   ```sql
   -- 查看用户表
   SELECT id, username, email, identify, status FROM SM_user;
   
   -- 查看医生申请
   SELECT * FROM SM_doctor_application;
   
   -- 查看登录日志
   SELECT * FROM SM_login_log ORDER BY login_time DESC LIMIT 10;
   ```

3. **加密数据查看**
   ```sql
   -- 注意：数据库中的敏感字段都是加密的
   SELECT username, email, phone FROM SM_user WHERE username = 'admin';
   -- email 和 phone 会显示为加密字符串
   ```

---

## 六、API测试工具

### 使用 Postman 测试

1. **导入接口文档**
   - 参考 `backed/API测试文档.md`
   - 配置环境变量：
     ```
     base_url: http://localhost:3000
     token: {{登录后获取的token}}
     ```

2. **测试登录接口**
   ```
   POST http://localhost:3000/api/user/login
   Content-Type: application/json
   
   {
     "username": "admin",
     "password": "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"
   }
   ```
   
   注意：密码需要前端SM3加密后的值

3. **测试需要认证的接口**
   ```
   GET http://localhost:3000/api/user/info
   Authorization: Bearer {{token}}
   ```

---

## 七、前端Mock数据说明

当前前端使用了 Mock 数据（`fonted/utils/mock.js`），在联调时需要：

1. **关闭Mock模式**
   - 检查 `fonted/utils/request.js`
   - 确保请求真实发送到后端，而不是返回Mock数据

2. **测试建议**
   - 先测试简单接口（登录、获取信息）
   - 再测试复杂接口（创建问诊、上传文件）
   - 最后测试完整业务流程

---

## 八、完整业务流程测试

### 场景 1：患者注册 -> 登录 -> 发起问诊

1. **注册新用户**
   - API: `POST /api/user/register`
   - 填写完整信息

2. **登录系统**
   - API: `POST /api/user/login`
   - 获取 Token

3. **查看医生列表**
   - API: `GET /api/user/doctors`
   - 选择一个医生

4. **发起问诊**
   - API: `POST /api/consultation/create`
   - 填写症状信息

5. **查看问诊列表**
   - API: `GET /api/consultation/list`
   - 验证问诊是否创建成功

### 场景 2：用户申请成为医生

1. **登录普通用户**
   - API: `POST /api/user/login`

2. **上传医生资格证书**
   - API: `POST /api/file/upload`
   - 获取文件URL

3. **提交医生申请**
   - API: `POST /api/user/apply-doctor`
   - 填写认证信息

4. **查询申请状态**
   - API: `GET /api/user/doctor-application`
   - 验证申请是否提交成功

5. **管理员审核（切换到admin账号）**
   - API: `GET /api/user/admin/doctor-applications`
   - API: `PUT /api/user/admin/review-doctor`

6. **验证身份变更**
   - API: `GET /api/user/info`
   - 检查 `identify` 是否变为 `doctor`

---

## 九、性能和安全检查

### 性能检查

1. **响应时间**
   - 登录接口：< 500ms
   - 查询接口：< 300ms
   - 加密操作：< 100ms

2. **数据库查询优化**
   - 检查是否使用索引
   - 避免 N+1 查询问题

### 安全检查

1. **密码安全**
   - ✅ 前端SM3加密
   - ✅ 后端二次加盐哈希
   - ✅ 数据库不存储明文密码

2. **敏感数据加密**
   - ✅ 邮箱、手机号 SM4加密
   - ✅ 身份证号 SM4加密
   - ✅ 病历数据 SM4加密

3. **Token安全**
   - ✅ JWT签名验证
   - ✅ Token过期时间：2小时
   - ✅ 退出登录清除Token

---

## 十、下一步工作

联调完成后，可以进行：

1. **功能完善**
   - WebSocket实时通信（问诊消息推送）
   - 文件上传下载
   - AI辅助诊断集成

2. **性能优化**
   - Redis缓存
   - 数据库查询优化
   - 前端懒加载

3. **部署准备**
   - 修改生产环境配置
   - HTTPS配置
   - 国密SSL证书

---

## 联系方式

如有问题，请检查以下文档：
- `backed/README.md` - 后端项目说明
- `backed/快速启动指南.md` - 快速启动指南
- `backed/API测试文档.md` - API测试文档
- `backed/项目完成情况说明.md` - 项目完成情况

祝联调顺利！🎉
