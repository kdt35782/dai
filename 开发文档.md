# 基于国密加密的网上看诊系统



***

背景：用于毕业设计，要求使用国密S系列来加密通信内容、数据库路内容。系统依旧是一个网上问诊系统，与聊天类似。

***



## 一、用户模块

***

数据库名：SM

表名：SM_user

***

数据库字段设计：

> id => 主键（BIGINT，自增）
>
> username => 用户昵称（唯一索引）
>
> password => 密码（SM3加密存储）
>
> email => 邮箱（唯一索引，SM4加密存储）
>
> phone => 手机号（唯一索引，SM4加密存储）
>
> real_name => 真实姓名（SM4加密存储）
>
> id_card => 身份证号（SM4加密存储，用于医生认证）
>
> identify => 身份标识（user：普通用户，admin：管理员，doctor：医生）
>
> avatar => 头像URL
>
> gender => 性别（0：未知，1：男，2：女）
>
> age => 年龄
>
> status => 账号状态（0：正常，1：禁用，2：待审核）
>
> doctor_cert => 医生资格证书URL（仅医生）
>
> doctor_title => 医生职称（仅医生）
>
> doctor_dept => 所属科室（仅医生）
>
> doctor_intro => 医生简介（仅医生）
>
> created_at => 创建时间
>
> updated_at => 更新时间
>
> last_login_time => 最后登录时间
>
> last_login_ip => 最后登录IP（SM4加密存储）



### 建表SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS SM DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE SM;

-- 用户表
CREATE TABLE IF NOT EXISTS SM_user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(128) NOT NULL COMMENT '密码(SM3加密)',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT '邮箱(SM4加密)',
    phone VARCHAR(255) COMMENT '手机号(SM4加密)',
    real_name VARCHAR(255) COMMENT '真实姓名(SM4加密)',
    id_card VARCHAR(255) COMMENT '身份证号(SM4加密)',
    identify ENUM('user', 'admin', 'doctor') NOT NULL DEFAULT 'user' COMMENT '身份标识',
    avatar VARCHAR(500) COMMENT '头像URL',
    gender TINYINT DEFAULT 0 COMMENT '性别(0:未知,1:男,2:女)',
    age INT COMMENT '年龄',
    status TINYINT DEFAULT 0 COMMENT '账号状态(0:正常,1:禁用,2:待审核)',
    doctor_cert VARCHAR(500) COMMENT '医生资格证书URL',
    doctor_title VARCHAR(50) COMMENT '医生职称',
    doctor_dept VARCHAR(50) COMMENT '所属科室',
    doctor_intro TEXT COMMENT '医生简介',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_time TIMESTAMP NULL COMMENT '最后登录时间',
    last_login_ip VARCHAR(255) COMMENT '最后登录IP(SM4加密)',
    INDEX idx_identify (identify),
    INDEX idx_status (status),
    INDEX idx_doctor_dept (doctor_dept)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 医生申请记录表
CREATE TABLE IF NOT EXISTS SM_doctor_application (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '申请ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    real_name VARCHAR(255) NOT NULL COMMENT '真实姓名(SM4加密)',
    id_card VARCHAR(255) NOT NULL COMMENT '身份证号(SM4加密)',
    phone VARCHAR(255) NOT NULL COMMENT '手机号(SM4加密)',
    doctor_cert VARCHAR(500) NOT NULL COMMENT '医生资格证书URL',
    doctor_title VARCHAR(50) NOT NULL COMMENT '医生职称',
    doctor_dept VARCHAR(50) NOT NULL COMMENT '所属科室',
    doctor_intro TEXT COMMENT '医生简介',
    status TINYINT DEFAULT 0 COMMENT '审核状态(0:待审核,1:已通过,2:已拒绝)',
    reject_reason TEXT COMMENT '拒绝原因',
    reviewer_id BIGINT COMMENT '审核人ID',
    review_time TIMESTAMP NULL COMMENT '审核时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES SM_user(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='医生申请记录表';

-- 用户登录日志表
CREATE TABLE IF NOT EXISTS SM_login_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
    user_id BIGINT COMMENT '用户ID',
    username VARCHAR(50) COMMENT '用户名',
    login_ip VARCHAR(255) NOT NULL COMMENT '登录IP(SM4加密)',
    login_location VARCHAR(100) COMMENT '登录地点',
    browser VARCHAR(50) COMMENT '浏览器类型',
    os VARCHAR(50) COMMENT '操作系统',
    status TINYINT NOT NULL COMMENT '登录状态(0:失败,1:成功)',
    msg VARCHAR(255) COMMENT '提示消息',
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
    INDEX idx_user_id (user_id),
    INDEX idx_login_time (login_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户登录日志表';
```



### API 功能设计

#### 1. 用户注册

**接口地址**：`POST /api/user/register`

**权限**：公开

**请求头**：
```
Content-Type: application/json
```

**请求体**：

```json
{
    "username": "zhangsan",
    "password": "Password123!@#",
    "email": "zhangsan@example.com",
    "phone": "13800138000",
    "verifyCode": "123456"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名，4-20个字符，只能包含字母、数字、下划线 |
| password | string | 是 | 密码，8-20位，必须包含大小写字母、数字和特殊字符 |
| email | string | 是 | 邮箱地址 |
| phone | string | 是 | 手机号码 |
| verifyCode | string | 是 | 验证码（后期对接邮箱或短信验证） |

**成功返回**：

```json
{
    "code": 200,
    "message": "注册成功",
    "data": {
        "userId": 1001,
        "username": "zhangsan",
        "email": "zhangsan@example.com"
    },
    "timestamp": 1701590400000
}
```

**错误返回**：

```json
{
    "code": 400,
    "message": "用户名已存在",
    "data": null,
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 400 | 参数错误（用户名已存在、邮箱已被注册、密码强度不够等） |
| 401 | 验证码错误或已过期 |
| 500 | 服务器内部错误 |



#### 2. 用户登录

**接口地址**：`POST /api/user/login`

**权限**：公开

**请求头**：
```
Content-Type: application/json
```

**请求体**：

```json
{
    "username": "zhangsan",
    "password": "Password123!@#",
    "loginType": "account"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名/邮箱/手机号 |
| password | string | 是 | 密码 |
| loginType | string | 否 | 登录类型（account:账号密码，默认） |

**成功返回**：

```json
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "tokenType": "Bearer",
        "expiresIn": 7200,
        "userInfo": {
            "userId": 1001,
            "username": "zhangsan",
            "email": "zhangsan@example.com",
            "identify": "user",
            "avatar": "https://example.com/avatar/1001.jpg",
            "status": 0
        }
    },
    "timestamp": 1701590400000
}
```

**错误返回**：

```json
{
    "code": 401,
    "message": "用户名或密码错误",
    "data": null,
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 400 | 参数错误 |
| 401 | 用户名或密码错误 |
| 403 | 账号已被禁用 |
| 500 | 服务器内部错误 |



#### 3. 获取当前用户信息

**接口地址**：`GET /api/user/info`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "userId": 1001,
        "username": "zhangsan",
        "email": "zhangsan@example.com",
        "phone": "13800138000",
        "realName": "张三",
        "identify": "user",
        "avatar": "https://example.com/avatar/1001.jpg",
        "gender": 1,
        "age": 28,
        "status": 0,
        "createdAt": "2024-01-01 12:00:00",
        "lastLoginTime": "2024-12-03 10:30:00"
    },
    "timestamp": 1701590400000
}
```



#### 4. 更新用户信息

**接口地址**：`PUT /api/user/info`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "avatar": "https://example.com/avatar/new.jpg",
    "gender": 1,
    "age": 28,
    "realName": "张三"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| avatar | string | 否 | 头像URL |
| gender | int | 否 | 性别(0:未知,1:男,2:女) |
| age | int | 否 | 年龄 |
| realName | string | 否 | 真实姓名 |

**成功返回**：

```json
{
    "code": 200,
    "message": "更新成功",
    "data": null,
    "timestamp": 1701590400000
}
```



#### 5. 修改密码

**接口地址**：`PUT /api/user/password`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "oldPassword": "OldPassword123!@#",
    "newPassword": "NewPassword456!@#",
    "confirmPassword": "NewPassword456!@#"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| oldPassword | string | 是 | 旧密码 |
| newPassword | string | 是 | 新密码，8-20位，必须包含大小写字母、数字和特殊字符 |
| confirmPassword | string | 是 | 确认密码 |

**成功返回**：

```json
{
    "code": 200,
    "message": "密码修改成功，请重新登录",
    "data": null,
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 400 | 参数错误（两次密码不一致、新密码强度不够等） |
| 401 | 旧密码错误 |
| 500 | 服务器内部错误 |



#### 6. 申请成为医生

**接口地址**：`POST /api/user/apply-doctor`

**权限**：需要登录（普通用户）

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "realName": "张三",
    "idCard": "110101199001011234",
    "phone": "13800138000",
    "doctorCert": "https://example.com/cert/doctor_cert.jpg",
    "doctorTitle": "主治医师",
    "doctorDept": "心内科",
    "doctorIntro": "从事心内科临床工作10年，擅长冠心病、高血压等疾病的诊治。"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| realName | string | 是 | 真实姓名 |
| idCard | string | 是 | 身份证号 |
| phone | string | 是 | 手机号 |
| doctorCert | string | 是 | 医生资格证书URL（需先上传图片） |
| doctorTitle | string | 是 | 医生职称 |
| doctorDept | string | 是 | 所属科室 |
| doctorIntro | string | 否 | 医生简介 |

**成功返回**：

```json
{
    "code": 200,
    "message": "申请已提交，请等待管理员审核",
    "data": {
        "applicationId": 5001
    },
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 400 | 参数错误或已有待审核的申请 |
| 403 | 当前用户已是医生 |
| 500 | 服务器内部错误 |



#### 7. 查询医生申请状态

**接口地址**：`GET /api/user/doctor-application`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "applicationId": 5001,
        "status": 0,
        "statusText": "待审核",
        "realName": "张三",
        "doctorTitle": "主治医师",
        "doctorDept": "心内科",
        "createdAt": "2024-12-01 10:00:00",
        "reviewTime": null,
        "rejectReason": null
    },
    "timestamp": 1701590400000
}
```

**status状态说明**：
- 0: 待审核
- 1: 已通过
- 2: 已拒绝



#### 8. 获取医生列表

**接口地址**：`GET /api/user/doctors`

**权限**：公开

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| dept | string | 否 | 科室筛选 |
| keyword | string | 否 | 关键词搜索（姓名、职称） |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 50,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "userId": 2001,
                "username": "doctor_zhang",
                "realName": "张医生",
                "avatar": "https://example.com/avatar/2001.jpg",
                "doctorTitle": "主治医师",
                "doctorDept": "心内科",
                "doctorIntro": "从事心内科临床工作10年",
                "gender": 1,
                "age": 35
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 9. 获取医生详情

**接口地址**：`GET /api/user/doctor/:userId`

**权限**：公开

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | int | 是 | 医生用户ID |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "userId": 2001,
        "username": "doctor_zhang",
        "realName": "张医生",
        "avatar": "https://example.com/avatar/2001.jpg",
        "doctorTitle": "主治医师",
        "doctorDept": "心内科",
        "doctorIntro": "从事心内科临床工作10年，擅长冠心病、高血压等疾病的诊治。",
        "gender": 1,
        "age": 35,
        "createdAt": "2024-01-01 12:00:00"
    },
    "timestamp": 1701590400000
}
```



#### 10. 用户退出登录

**接口地址**：`POST /api/user/logout`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "退出成功",
    "data": null,
    "timestamp": 1701590400000
}
```



---

### 管理员接口

#### 11. 审核医生申请

**接口地址**：`PUT /api/user/admin/review-doctor`

**权限**：管理员

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "applicationId": 5001,
    "status": 1,
    "rejectReason": ""
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| applicationId | int | 是 | 申请ID |
| status | int | 是 | 审核结果(1:通过,2:拒绝) |
| rejectReason | string | 否 | 拒绝原因（拒绝时必填） |

**成功返回**：

```json
{
    "code": 200,
    "message": "审核成功",
    "data": null,
    "timestamp": 1701590400000
}
```



#### 12. 获取医生申请列表

**接口地址**：`GET /api/user/admin/doctor-applications`

**权限**：管理员

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| status | int | 否 | 状态筛选(0:待审核,1:已通过,2:已拒绝) |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 20,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "applicationId": 5001,
                "userId": 1001,
                "username": "zhangsan",
                "realName": "张三",
                "idCard": "110101199001011234",
                "phone": "13800138000",
                "doctorCert": "https://example.com/cert/doctor_cert.jpg",
                "doctorTitle": "主治医师",
                "doctorDept": "心内科",
                "doctorIntro": "从事心内科临床工作10年",
                "status": 0,
                "statusText": "待审核",
                "createdAt": "2024-12-01 10:00:00",
                "reviewTime": null,
                "rejectReason": null
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 13. 获取用户列表

**接口地址**：`GET /api/user/admin/users`

**权限**：管理员

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| identify | string | 否 | 身份筛选(user/admin/doctor) |
| status | int | 否 | 状态筛选(0:正常,1:禁用) |
| keyword | string | 否 | 关键词搜索（用户名、邮箱） |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 100,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "userId": 1001,
                "username": "zhangsan",
                "email": "zhangsan@example.com",
                "phone": "13800138000",
                "identify": "user",
                "status": 0,
                "createdAt": "2024-01-01 12:00:00",
                "lastLoginTime": "2024-12-03 10:30:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 14. 禁用/启用用户

**接口地址**：`PUT /api/user/admin/status`

**权限**：管理员

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "userId": 1001,
    "status": 1
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | int | 是 | 用户ID |
| status | int | 是 | 状态(0:启用,1:禁用) |

**成功返回**：

```json
{
    "code": 200,
    "message": "操作成功",
    "data": null,
    "timestamp": 1701590400000
}
```



#### 15. 获取登录日志

**接口地址**：`GET /api/user/admin/login-logs`

**权限**：管理员

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| userId | int | 否 | 用户ID筛选 |
| status | int | 否 | 登录状态(0:失败,1:成功) |
| startTime | string | 否 | 开始时间 |
| endTime | string | 否 | 结束时间 |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 500,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "logId": 10001,
                "userId": 1001,
                "username": "zhangsan",
                "loginIp": "192.168.1.100",
                "loginLocation": "北京市",
                "browser": "Chrome",
                "os": "Windows 10",
                "status": 1,
                "statusText": "成功",
                "msg": "登录成功",
                "loginTime": "2024-12-03 10:30:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



---

### 统一返回格式说明

所有API接口统一使用以下返回格式：

```json
{
    "code": 200,
    "message": "操作描述",
    "data": {},
    "timestamp": 1701590400000
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| code | int | 状态码（200:成功，其他为错误码） |
| message | string | 提示信息 |
| data | object/null | 返回的数据，失败时为null |
| timestamp | long | 时间戳（毫秒） |

**通用错误码**：

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证或token无效 |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |



---

### 国密加密说明

**SM3加密**（用于密码）：
- 密码在前端使用SM3进行哈希后传输
- 后端接收到密码后再次使用SM3+盐值进行哈希存储
- 双重加密确保密码安全

**SM4加密**（用于敏感数据）：
- 邮箱、手机号、身份证号、真实姓名、登录IP等敏感信息使用SM4加密存储
- 采用CBC模式，密钥由后端密钥管理系统统一管理
- 数据在存储前加密，读取后解密

**SM2加密**（用于通信）：
- 前后端通信中的敏感数据使用SM2非对称加密
- 后端提供公钥，前端使用公钥加密数据
- 后端使用私钥解密数据

**HTTPS + 国密SSL**：
- 使用国密SSL证书（SM2算法）建立安全连接
- 确保传输层安全



## 二、国密密钥管理模块

### API 功能设计

#### 1. 获取系统公钥

**接口地址**：`GET /api/crypto/public-key`

**权限**：公开

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyType | string | 是 | 密钥类型(sm2:非对称加密, paillier:同态加密) |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "keyType": "sm2",
        "publicKey": "04B2C5E...",
        "keyId": "KEY_20241203_001",
        "expiresAt": "2025-03-03 00:00:00"
    },
    "timestamp": 1701590400000
}
```

**说明**：
- SM2公钥用于前端加密敏感数据传输
- Paillier公钥用于AI同态计算



#### 2. 生成用户密钥对

**接口地址**：`POST /api/crypto/generate-keypair`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "keyType": "sm2",
    "purpose": "authentication"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyType | string | 是 | 密钥类型(sm2) |
| purpose | string | 是 | 用途(authentication:身份认证, encryption:数据加密) |

**成功返回**：

```json
{
    "code": 200,
    "message": "密钥生成成功",
    "data": {
        "keyId": "USR_KEY_1001_001",
        "publicKey": "04B2C5E...",
        "privateKey": "encrypted_private_key...",
        "createdAt": "2024-12-03 10:00:00"
    },
    "timestamp": 1701590400000
}
```

**说明**：
- 私钥使用用户密码派生密钥加密后返回
- 客户端需安全存储私钥



#### 3. 生成会话密钥

**接口地址**：`POST /api/crypto/session-key`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "会话密钥生成成功",
    "data": {
        "sessionId": "SID_20241203_1001",
        "encryptedSessionKey": "SM2加密的SM4会话密钥",
        "expiresIn": 7200
    },
    "timestamp": 1701590400000
}
```

**说明**：
- 会话密钥用SM2加密，使用用户公钥加密
- 客户端使用私钥解密获得SM4会话密钥
- 用于加密本次会话的敏感数据



## 三、文件上传模块

### API 功能设计

#### 1. 上传文件

**接口地址**：`POST /api/file/upload`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**请求体**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | file | 是 | 文件对象 |
| fileType | string | 是 | 文件类型(avatar:头像, cert:证书, medical:病历附件) |
| encrypt | boolean | 否 | 是否加密存储，默认true |

**成功返回**：

```json
{
    "code": 200,
    "message": "上传成功",
    "data": {
        "fileId": "FILE_20241203_001",
        "fileUrl": "https://example.com/files/encrypted/FILE_20241203_001.enc",
        "originalName": "doctor_cert.jpg",
        "fileSize": 204800,
        "mimeType": "image/jpeg",
        "encrypted": true,
        "uploadTime": "2024-12-03 10:00:00"
    },
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 400 | 文件格式不支持或文件过大 |
| 401 | 未认证 |
| 413 | 文件大小超过限制 |
| 500 | 上传失败 |

**文件大小限制**：
- 头像：最大2MB
- 证书：最大5MB
- 病历附件：最大10MB



#### 2. 下载文件

**接口地址**：`GET /api/file/download/:fileId`

**权限**：需要登录且有权限

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| fileId | string | 是 | 文件ID |

**成功返回**：
- 直接返回文件流
- 如果文件已加密，服务端自动解密后返回

**响应头**：
```
Content-Type: image/jpeg
Content-Disposition: attachment; filename="doctor_cert.jpg"
```



## 四、问诊模块

### 数据库设计

#### 4.1 问诊记录表

```sql
-- 问诊记录表
CREATE TABLE IF NOT EXISTS SM_consultation (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '问诊ID',
    patient_id BIGINT NOT NULL COMMENT '患者ID',
    doctor_id BIGINT COMMENT '医生ID',
    consultation_no VARCHAR(50) NOT NULL UNIQUE COMMENT '问诊编号',
    chief_complaint TEXT COMMENT '主诉(SM4加密)',
    symptoms_encrypted TEXT COMMENT '症状特征(Paillier加密,用于AI)',
    ai_risk_score INT COMMENT 'AI风险评分(0-100)',
    ai_diagnosis TEXT COMMENT 'AI初步诊断建议',
    doctor_diagnosis TEXT COMMENT '医生诊断(SM4加密)',
    prescription TEXT COMMENT '处方信息(SM4加密)',
    status TINYINT DEFAULT 0 COMMENT '状态(0:待接诊,1:问诊中,2:已完成,3:已取消)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    completed_at TIMESTAMP NULL COMMENT '完成时间',
    FOREIGN KEY (patient_id) REFERENCES SM_user(id),
    FOREIGN KEY (doctor_id) REFERENCES SM_user(id),
    INDEX idx_patient_id (patient_id),
    INDEX idx_doctor_id (doctor_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='问诊记录表';

-- 问诊消息表
CREATE TABLE IF NOT EXISTS SM_consultation_message (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '消息ID',
    consultation_id BIGINT NOT NULL COMMENT '问诊ID',
    sender_id BIGINT NOT NULL COMMENT '发送者ID',
    receiver_id BIGINT NOT NULL COMMENT '接收者ID',
    message_type TINYINT NOT NULL COMMENT '消息类型(1:文本,2:图片,3:语音,4:处方)',
    content TEXT NOT NULL COMMENT '消息内容(SM4加密)',
    file_url VARCHAR(500) COMMENT '文件URL',
    is_read TINYINT DEFAULT 0 COMMENT '是否已读(0:未读,1:已读)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
    FOREIGN KEY (consultation_id) REFERENCES SM_consultation(id) ON DELETE CASCADE,
    INDEX idx_consultation_id (consultation_id),
    INDEX idx_sender_id (sender_id),
    INDEX idx_receiver_id (receiver_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='问诊消息表';
```



### API 功能设计

#### 1. 创建问诊（患者发起）

**接口地址**：`POST /api/consultation/create`

**权限**：需要登录（患者）

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "doctorId": 2001,
    "chiefComplaint": "最近3天头晕头痛，血压偏高",
    "symptoms": {
        "age": 45,
        "gender": 1,
        "height": 175,
        "weight": 80,
        "bloodPressure": "150/95",
        "heartRate": 88,
        "history": ["高血压病史5年"],
        "durationDays": 3
    },
    "attachments": ["FILE_20241203_001"],
    "needAI": true
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| doctorId | int | 否 | 指定医生ID，不指定则系统分配 |
| chiefComplaint | string | 是 | 主诉描述 |
| symptoms | object | 是 | 症状详情（会被SM4加密存储） |
| attachments | array | 否 | 附件文件ID列表 |
| needAI | boolean | 否 | 是否需要AI辅助诊断，默认true |

**成功返回**：

```json
{
    "code": 200,
    "message": "问诊创建成功",
    "data": {
        "consultationId": 10001,
        "consultationNo": "CN20241203001",
        "doctorId": 2001,
        "doctorName": "张医生",
        "status": 0,
        "aiDiagnosis": {
            "riskScore": 65,
            "riskLevel": "medium",
            "advice": "建议线下就诊心内科，进一步检查",
            "possibleDiseases": ["高血压2级", "血压控制不佳"]
        },
        "createdAt": "2024-12-03 10:00:00"
    },
    "timestamp": 1701590400000
}
```

**说明**：
- 症状数据会使用Paillier同态加密用于AI计算
- AI诊断结果实时返回
- 主诉和详细症状使用SM4加密存储



#### 2. 获取问诊列表

**接口地址**：`GET /api/consultation/list`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| status | int | 否 | 状态筛选(0:待接诊,1:问诊中,2:已完成,3:已取消) |
| role | string | 否 | 角色(patient:作为患者,doctor:作为医生) |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 50,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "consultationId": 10001,
                "consultationNo": "CN20241203001",
                "patientId": 1001,
                "patientName": "张三",
                "doctorId": 2001,
                "doctorName": "李医生",
                "chiefComplaint": "头晕头痛3天",
                "status": 1,
                "statusText": "问诊中",
                "unreadCount": 2,
                "createdAt": "2024-12-03 10:00:00",
                "updatedAt": "2024-12-03 10:30:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 3. 获取问诊详情

**接口地址**：`GET /api/consultation/:consultationId`

**权限**：需要登录且是问诊相关人

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| consultationId | int | 是 | 问诊ID |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "consultationId": 10001,
        "consultationNo": "CN20241203001",
        "patient": {
            "userId": 1001,
            "username": "zhangsan",
            "realName": "张三",
            "age": 45,
            "gender": 1
        },
        "doctor": {
            "userId": 2001,
            "username": "doctor_li",
            "realName": "李医生",
            "doctorTitle": "主治医师",
            "doctorDept": "心内科"
        },
        "chiefComplaint": "最近3天头晕头痛，血压偏高",
        "symptoms": {
            "bloodPressure": "150/95",
            "heartRate": 88,
            "history": ["高血压病史5年"],
            "durationDays": 3
        },
        "aiDiagnosis": {
            "riskScore": 65,
            "riskLevel": "medium",
            "advice": "建议线下就诊心内科，进一步检查"
        },
        "doctorDiagnosis": "高血压2级，血压控制不佳",
        "prescription": {
            "medications": [
                {"name": "氨氯地平", "dose": "5mg", "frequency": "每日一次"}
            ],
            "advice": "低盐饮食，定期监测血压"
        },
        "status": 2,
        "createdAt": "2024-12-03 10:00:00",
        "completedAt": "2024-12-03 11:00:00"
    },
    "timestamp": 1701590400000
}
```



#### 4. 医生接诊

**接口地址**：`POST /api/consultation/:consultationId/accept`

**权限**：需要登录（医生）

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| consultationId | int | 是 | 问诊ID |

**成功返回**：

```json
{
    "code": 200,
    "message": "接诊成功",
    "data": {
        "consultationId": 10001,
        "status": 1
    },
    "timestamp": 1701590400000
}
```



#### 5. 发送问诊消息

**接口地址**：`POST /api/consultation/:consultationId/message`

**权限**：需要登录且是问诊相关人

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "messageType": 1,
    "content": "您好，根据您的症状描述，建议您...",
    "fileUrl": ""
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| messageType | int | 是 | 消息类型(1:文本,2:图片,3:语音,4:处方) |
| content | string | 是 | 消息内容 |
| fileUrl | string | 否 | 文件URL（图片、语音类型时必填） |

**成功返回**：

```json
{
    "code": 200,
    "message": "发送成功",
    "data": {
        "messageId": 50001,
        "consultationId": 10001,
        "senderId": 2001,
        "receiverId": 1001,
        "messageType": 1,
        "content": "您好，根据您的症状描述，建议您...",
        "createdAt": "2024-12-03 10:30:00"
    },
    "timestamp": 1701590400000
}
```

**说明**：
- 消息内容使用SM4加密存储
- 实时推送给接收方（WebSocket）



#### 6. 获取问诊消息记录

**接口地址**：`GET /api/consultation/:consultationId/messages`

**权限**：需要登录且是问诊相关人

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认20 |
| lastMessageId | int | 否 | 最后一条消息ID（用于增量加载） |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 30,
        "page": 1,
        "pageSize": 20,
        "list": [
            {
                "messageId": 50001,
                "senderId": 2001,
                "senderName": "李医生",
                "senderAvatar": "https://example.com/avatar/2001.jpg",
                "messageType": 1,
                "content": "您好，根据您的症状描述...",
                "isRead": 1,
                "createdAt": "2024-12-03 10:30:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 7. 完成问诊（医生）

**接口地址**：`POST /api/consultation/:consultationId/complete`

**权限**：需要登录（医生）

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "diagnosis": "高血压2级，血压控制不佳",
    "prescription": {
        "medications": [
            {"name": "氨氯地平", "dose": "5mg", "frequency": "每日一次"},
            {"name": "氢氯噻嗪", "dose": "12.5mg", "frequency": "每日一次"}
        ],
        "advice": "低盐饮食，定期监测血压",
        "followUp": "2周后复诊"
    }
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| diagnosis | string | 是 | 诊断结论 |
| prescription | object | 是 | 处方信息 |

**成功返回**：

```json
{
    "code": 200,
    "message": "问诊已完成",
    "data": {
        "consultationId": 10001,
        "status": 2,
        "completedAt": "2024-12-03 11:00:00"
    },
    "timestamp": 1701590400000
}
```



## 五、病历模块

### 数据库设计

```sql
-- 电子病历表
CREATE TABLE IF NOT EXISTS SM_medical_record (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '病历ID',
    record_no VARCHAR(50) NOT NULL UNIQUE COMMENT '病历编号',
    patient_id BIGINT NOT NULL COMMENT '患者ID',
    consultation_id BIGINT COMMENT '关联问诊ID',
    record_type TINYINT NOT NULL COMMENT '病历类型(1:门诊,2:在线问诊)',
    chief_complaint TEXT COMMENT '主诉(SM4加密)',
    present_illness TEXT COMMENT '现病史(SM4加密)',
    past_history TEXT COMMENT '既往史(SM4加密)',
    diagnosis TEXT COMMENT '诊断(SM4加密)',
    treatment_plan TEXT COMMENT '治疗方案(SM4加密)',
    doctor_id BIGINT COMMENT '诊疗医生ID',
    access_policy TEXT COMMENT '访问策略(SM9属性基加密)',
    data_hash VARCHAR(128) COMMENT '数据完整性哈希(SM3)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (patient_id) REFERENCES SM_user(id),
    FOREIGN KEY (consultation_id) REFERENCES SM_consultation(id),
    FOREIGN KEY (doctor_id) REFERENCES SM_user(id),
    INDEX idx_patient_id (patient_id),
    INDEX idx_consultation_id (consultation_id),
    INDEX idx_record_no (record_no),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='电子病历表';

-- 病历访问日志表
CREATE TABLE IF NOT EXISTS SM_record_access_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
    record_id BIGINT NOT NULL COMMENT '病历ID',
    accessor_id BIGINT NOT NULL COMMENT '访问者ID',
    accessor_name VARCHAR(50) COMMENT '访问者姓名',
    access_type TINYINT NOT NULL COMMENT '访问类型(1:查看,2:编辑,3:下载)',
    access_result TINYINT NOT NULL COMMENT '访问结果(0:失败,1:成功)',
    failure_reason VARCHAR(255) COMMENT '失败原因',
    ip_address VARCHAR(255) COMMENT '访问IP(SM4加密)',
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '访问时间',
    FOREIGN KEY (record_id) REFERENCES SM_medical_record(id) ON DELETE CASCADE,
    INDEX idx_record_id (record_id),
    INDEX idx_accessor_id (accessor_id),
    INDEX idx_access_time (access_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='病历访问日志表';
```



### API 功能设计

#### 1. 创建病历

**接口地址**：`POST /api/medical-record/create`

**权限**：需要登录（医生）

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "patientId": 1001,
    "consultationId": 10001,
    "recordType": 2,
    "chiefComplaint": "头晕头痛3天",
    "presentIllness": "患者3天前无明显诱因出现头晕、头痛...",
    "pastHistory": "高血压病史5年",
    "diagnosis": "高血压2级",
    "treatmentPlan": "1. 氨氯地平5mg qd\n2. 低盐饮食",
    "accessPolicy": {
        "allowedDepts": ["心内科", "急诊科"],
        "allowedTitles": ["主治医师", "副主任医师", "主任医师"]
    }
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| patientId | int | 是 | 患者ID |
| consultationId | int | 否 | 关联问诊ID |
| recordType | int | 是 | 病历类型(1:门诊,2:在线问诊) |
| chiefComplaint | string | 是 | 主诉 |
| presentIllness | string | 是 | 现病史 |
| pastHistory | string | 否 | 既往史 |
| diagnosis | string | 是 | 诊断 |
| treatmentPlan | string | 是 | 治疗方案 |
| accessPolicy | object | 是 | 访问策略（属性基访问控制） |

**成功返回**：

```json
{
    "code": 200,
    "message": "病历创建成功",
    "data": {
        "recordId": 20001,
        "recordNo": "MR20241203001",
        "dataHash": "a3f5e...",
        "createdAt": "2024-12-03 11:00:00"
    },
    "timestamp": 1701590400000
}
```

**说明**：
- 病历内容使用SM4加密存储
- 访问策略使用SM9属性基加密
- 生成SM3数据哈希确保完整性



#### 2. 查看病历

**接口地址**：`GET /api/medical-record/:recordId`

**权限**：需要登录且有访问权限

**请求头**：
```
Authorization: Bearer <token>
```

**路径参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| recordId | int | 是 | 病历ID |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "recordId": 20001,
        "recordNo": "MR20241203001",
        "patient": {
            "userId": 1001,
            "realName": "张三",
            "age": 45,
            "gender": 1
        },
        "recordType": 2,
        "chiefComplaint": "头晕头痛3天",
        "presentIllness": "患者3天前无明显诱因出现头晕、头痛...",
        "pastHistory": "高血压病史5年",
        "diagnosis": "高血压2级",
        "treatmentPlan": "1. 氨氯地平5mg qd\n2. 低盐饮食",
        "doctor": {
            "userId": 2001,
            "realName": "李医生",
            "doctorTitle": "主治医师",
            "doctorDept": "心内科"
        },
        "integrityVerified": true,
        "createdAt": "2024-12-03 11:00:00"
    },
    "timestamp": 1701590400000
}
```

**错误码说明**：

| 错误码 | 说明 |
|--------|------|
| 403 | 无权限访问（属性不匹配） |
| 404 | 病历不存在 |
| 500 | 数据完整性验证失败 |



#### 3. 获取患者病历列表

**接口地址**：`GET /api/medical-record/patient/:patientId`

**权限**：需要登录（患者本人或有权限的医生）

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 15,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "recordId": 20001,
                "recordNo": "MR20241203001",
                "recordType": 2,
                "diagnosis": "高血压2级",
                "doctorName": "李医生",
                "createdAt": "2024-12-03 11:00:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 4. 授权病历访问

**接口地址**：`POST /api/medical-record/:recordId/authorize`

**权限**：需要登录（患者本人）

**请求头**：
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**：

```json
{
    "doctorId": 2002,
    "expiresIn": 86400,
    "accessLevel": "read"
}
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| doctorId | int | 是 | 授权医生ID |
| expiresIn | int | 否 | 有效期（秒），默认24小时 |
| accessLevel | string | 否 | 访问级别(read:只读, write:可编辑)，默认read |

**成功返回**：

```json
{
    "code": 200,
    "message": "授权成功",
    "data": {
        "accessToken": "临时访问令牌",
        "expiresAt": "2024-12-04 11:00:00"
    },
    "timestamp": 1701590400000
}
```



#### 5. 查看病历访问日志

**接口地址**：`GET /api/medical-record/:recordId/access-logs`

**权限**：需要登录（患者本人或管理员）

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 8,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "logId": 30001,
                "accessorId": 2001,
                "accessorName": "李医生",
                "accessType": 1,
                "accessTypeText": "查看",
                "accessResult": 1,
                "accessResultText": "成功",
                "ipAddress": "192.168.1.100",
                "accessTime": "2024-12-03 11:05:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



## 六、消息通知模块

### 数据库设计

```sql
-- 系统通知表
CREATE TABLE IF NOT EXISTS SM_notification (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '通知ID',
    user_id BIGINT NOT NULL COMMENT '接收用户ID',
    notification_type TINYINT NOT NULL COMMENT '通知类型(1:系统,2:问诊,3:审核,4:提醒)',
    title VARCHAR(100) NOT NULL COMMENT '通知标题',
    content TEXT COMMENT '通知内容',
    related_id BIGINT COMMENT '关联ID（问诊ID、申请ID等）',
    related_type VARCHAR(50) COMMENT '关联类型',
    is_read TINYINT DEFAULT 0 COMMENT '是否已读(0:未读,1:已读)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    read_at TIMESTAMP NULL COMMENT '读取时间',
    FOREIGN KEY (user_id) REFERENCES SM_user(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_is_read (is_read),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统通知表';
```



### API 功能设计

#### 1. 获取通知列表

**接口地址**：`GET /api/notification/list`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页数量，默认10 |
| isRead | int | 否 | 筛选(0:未读,1:已读) |
| notificationType | int | 否 | 通知类型筛选 |

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "total": 25,
        "unreadCount": 5,
        "page": 1,
        "pageSize": 10,
        "list": [
            {
                "notificationId": 40001,
                "notificationType": 2,
                "notificationTypeText": "问诊通知",
                "title": "新的问诊消息",
                "content": "李医生回复了您的问诊",
                "relatedId": 10001,
                "relatedType": "consultation",
                "isRead": 0,
                "createdAt": "2024-12-03 10:30:00"
            }
        ]
    },
    "timestamp": 1701590400000
}
```



#### 2. 标记通知已读

**接口地址**：`PUT /api/notification/:notificationId/read`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "标记成功",
    "data": null,
    "timestamp": 1701590400000
}
```



#### 3. 标记全部已读

**接口地址**：`PUT /api/notification/read-all`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "全部标记成功",
    "data": {
        "markedCount": 5
    },
    "timestamp": 1701590400000
}
```



#### 4. 获取未读数量

**接口地址**：`GET /api/notification/unread-count`

**权限**：需要登录

**请求头**：
```
Authorization: Bearer <token>
```

**成功返回**：

```json
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "totalUnread": 5,
        "systemUnread": 1,
        "consultationUnread": 3,
        "auditUnread": 1
    },
    "timestamp": 1701590400000
}
```

