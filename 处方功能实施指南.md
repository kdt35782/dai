# 完整的处方开具功能实施指南

## 功能概述

本次升级为系统添加了完整的药品数据库和处方开具功能，医生可以根据AI诊断助手的建议在药品库中开具处方。

---

## 主要功能

### 1. 药品数据库管理
- 20种常用药品数据
- 包含抗生素、降压药、降糖药、感冒药等7大类
- 支持药品搜索和分类查询

### 2. 智能处方开具
- 医生可根据AI诊断推荐开具处方
- 自动计算处方总金额
- 支持用法用量详细说明

### 3. 处方查询
- 患者可查看自己的处方
- 医生可查看开具的处方记录
- 处方与问诊和病历关联

---

## 实施步骤

### 第一步:初始化药品数据库

执行SQL脚本创建药品相关表并插入初始数据:

```bash
# 在数据库中执行
mysql -u root -p SM < database/medicine_database.sql
```

**创建的表:**
1. `SM_medicine` - 药品基础信息表
2. `SM_prescription` - 处方表
3. `SM_prescription_detail` - 处方明细表

**初始数据:**
- 20种常用药品已自动插入

---

### 第二步:启动后端服务

后端代码已全部完成,包含:

**新增文件:**
- `internal/model/models.go` - 添加了Medicine、Prescription、PrescriptionDetail模型
- `internal/repository/medicine_repository.go` - 药品数据访问层
- `internal/repository/prescription_repository.go` - 处方数据访问层
- `internal/service/prescription_service.go` - 处方业务逻辑
- `internal/api/handler/prescription_handler.go` - 处方API处理器

**修改文件:**
- `internal/service/consultation_service.go` - 支持处方开具
- `internal/api/handler/consultation_handler.go` - 支持处方参数
- `internal/api/routes.go` - 添加处方相关路由

启动服务:
```bash
cd backed
go run cmd/main.go
```

---

### 第三步:API接口说明

#### 1. 搜索药品
```
GET /api/prescription/medicines/search
参数:
- keyword: 关键词(可选)
- category: 分类(可选)
- page: 页码(默认1)
- pageSize: 每页数量(默认20)

响应:
{
  "code": 200,
  "data": {
    "list": [...],
    "total": 20,
    "page": 1,
    "pageSize": 20
  }
}
```

#### 2. 获取AI推荐药品
```
POST /api/prescription/medicines/recommend
请求体:
{
  "aiDiagnosis": "患者主诉头痛、发热..."
}

响应:
{
  "code": 200,
  "data": [
    {
      "medicineId": 1,
      "medicineName": "阿莫西林胶囊",
      "specification": "0.25g*24粒",
      "price": 12.50,
      "indications": "适用于敏感菌所致的呼吸道感染...",
      "usageDosage": "口服，成人一次0.5g，每6-8小时1次"
    }
  ]
}
```

#### 3. 完成问诊(新版支持处方)
```
POST /api/consultation/finish
请求体:
{
  "consultationId": 123,
  "diagnosis": "上呼吸道感染",
  "prescription": [
    {
      "medicineId": 1,
      "quantity": 2,
      "usage": "口服",
      "frequency": "每日3次",
      "dosage": "每次2粒",
      "duration": "7天",
      "notes": "饭后服用"
    }
  ]
}

响应:
{
  "code": 200,
  "message": "问诊已完成"
}
```

**兼容性说明:**
- prescription可以是字符串(旧版本,直接传入处方文本)
- prescription可以是数组(新版本,传入药品列表,自动创建处方)

#### 4. 获取处方详情
```
GET /api/prescription/:prescriptionId
响应:
{
  "code": 200,
  "data": {
    "prescriptionId": 1,
    "prescriptionNo": "RX1734412345",
    "diagnosis": "上呼吸道感染",
    "totalAmount": 25.00,
    "details": [...]
  }
}
```

---

## 前端集成建议

### 1. 问诊详情页面增强

在医生问诊详情页面添加:

```vue
<template>
  <view class="consultation-detail">
    <!-- 现有的问诊信息 -->
    
    <!-- AI诊断建议 -->
    <view v-if="consultation.aiDiagnosis" class="ai-section">
      <text class="section-title">AI诊断建议</text>
      <view class="ai-content">
        {{ consultation.aiDiagnosis.diagnosis }}
      </view>
      <button @click="getRecommendedMedicines">AI推荐用药</button>
    </view>
    
    <!-- 药品选择 -->
    <view class="medicine-section">
      <text class="section-title">开具处方</text>
      <button @click="searchMedicines">添加药品</button>
      
      <view v-for="(item, index) in selectedMedicines" :key="index" class="medicine-item">
        <text>{{ item.medicineName }}</text>
        <input v-model="item.dosage" placeholder="用量"/>
        <input v-model="item.frequency" placeholder="频次"/>
        <input v-model="item.duration" placeholder="疗程"/>
      </view>
    </view>
    
    <!-- 诊断和处方 -->
    <textarea v-model="diagnosis" placeholder="请输入诊断结果"></textarea>
    
    <button @click="finishConsultation">完成问诊</button>
  </view>
</template>

<script>
export default {
  data() {
    return {
      consultation: {},
      diagnosis: '',
      selectedMedicines: [],
      recommendedMedicines: []
    }
  },
  methods: {
    // 获取AI推荐药品
    async getRecommendedMedicines() {
      const res = await this.$http.post('/prescription/medicines/recommend', {
        aiDiagnosis: this.consultation.aiDiagnosis.diagnosis
      })
      this.recommendedMedicines = res.data
      // 显示推荐药品列表供医生选择
    },
    
    // 搜索药品
    async searchMedicines() {
      // 打开药品搜索页面
      uni.navigateTo({
        url: '/pages/medicine/search'
      })
    },
    
    // 完成问诊
    async finishConsultation() {
      const prescription = this.selectedMedicines.map(item => ({
        medicineId: item.medicineId,
        quantity: item.quantity || 1,
        usage: '口服',
        frequency: item.frequency || '每日3次',
        dosage: item.dosage || '每次1片',
        duration: item.duration || '7天',
        notes: item.notes || '',
        unitPrice: item.price
      }))
      
      await this.$http.post('/consultation/finish', {
        consultationId: this.consultationId,
        diagnosis: this.diagnosis,
        prescription: prescription // 新版本传入药品数组
      })
      
      uni.showToast({ title: '问诊完成', icon: 'success' })
      setTimeout(() => uni.navigateBack(), 1500)
    }
  }
}
</script>
```

### 2. 创建药品搜索页面

```vue
<template>
  <view class="medicine-search">
    <input v-model="keyword" @input="searchMedicines" placeholder="搜索药品"/>
    
    <view class="category-tabs">
      <view v-for="cat in categories" :key="cat" 
            :class="{active: category === cat}"
            @click="selectCategory(cat)">
        {{ cat }}
      </view>
    </view>
    
    <view v-for="medicine in medicines" :key="medicine.medicineId" 
          class="medicine-item"
          @click="selectMedicine(medicine)">
      <view class="medicine-name">{{ medicine.medicineName }}</view>
      <view class="medicine-spec">{{ medicine.specification }}</view>
      <view class="medicine-price">¥{{ medicine.price }}/{{ medicine.unit }}</view>
      <view class="medicine-usage">{{ medicine.usageDosage }}</view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      keyword: '',
      category: '',
      categories: ['全部', '抗生素', '降压药', '降糖药', '感冒药', '止咳化痰', '消化系统'],
      medicines: []
    }
  },
  methods: {
    async searchMedicines() {
      const res = await this.$http.get('/prescription/medicines/search', {
        params: {
          keyword: this.keyword,
          category: this.category === '全部' ? '' : this.category,
          page: 1,
          pageSize: 20
        }
      })
      this.medicines = res.data.list
    },
    
    selectCategory(cat) {
      this.category = cat
      this.searchMedicines()
    },
    
    selectMedicine(medicine) {
      // 返回选中的药品
      uni.$emit('selectMedicine', medicine)
      uni.navigateBack()
    }
  },
  
  onLoad() {
    this.searchMedicines()
  }
}
</script>
```

---

## 数据库表结构

### SM_medicine (药品表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| medicine_code | VARCHAR(50) | 药品编码 |
| medicine_name | VARCHAR(200) | 药品名称 |
| category | VARCHAR(50) | 分类 |
| specification | VARCHAR(100) | 规格 |
| price | DECIMAL(10,2) | 单价 |
| indications | TEXT | 适应症 |
| usage_dosage | TEXT | 用法用量 |

### SM_prescription (处方表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| prescription_no | VARCHAR(50) | 处方编号 |
| consultation_id | BIGINT | 问诊ID |
| patient_id | BIGINT | 患者ID |
| doctor_id | BIGINT | 医生ID |
| diagnosis | TEXT | 诊断(加密) |
| total_amount | DECIMAL(10,2) | 总金额 |

### SM_prescription_detail (处方明细表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| prescription_id | BIGINT | 处方ID |
| medicine_id | BIGINT | 药品ID |
| quantity | INT | 数量 |
| usage | VARCHAR(100) | 用法 |
| frequency | VARCHAR(100) | 频次 |
| dosage | VARCHAR(100) | 单次剂量 |
| duration | VARCHAR(50) | 疗程 |

---

## 测试流程

### 1. 测试药品搜索
```bash
curl -X GET "http://localhost:3000/api/prescription/medicines/search?keyword=阿莫西林" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. 测试AI推荐药品
```bash
curl -X POST "http://localhost:3000/api/prescription/medicines/recommend" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"aiDiagnosis": "患者主诉发热、咳嗽，体温38.5°C"}'
```

### 3. 测试开具处方
```bash
curl -X POST "http://localhost:3000/api/consultation/finish" \
  -H "Authorization: Bearer DOCTOR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "consultationId": 1,
    "diagnosis": "上呼吸道感染",
    "prescription": [
      {
        "medicineId": 1,
        "quantity": 2,
        "usage": "口服",
        "frequency": "每日3次",
        "dosage": "每次2粒",
        "duration": "7天",
        "unitPrice": 12.50
      }
    ]
  }'
```

---

## 注意事项

1. **数据加密**: 处方中的诊断信息使用SM4加密存储
2. **数据完整性**: 处方使用SM3哈希验证数据完整性
3. **权限控制**: 只有医生可以开具处方,患者只能查看自己的处方
4. **向后兼容**: 旧版本的处方文本格式仍然支持

---

## 扩展建议

1. **药品库扩展**: 可继续添加更多药品数据
2. **处方审核**: 可添加药师审核功能
3. **用药提醒**: 可添加患者用药提醒功能
4. **电子处方**: 可对接电子处方系统
5. **药品库存**: 可添加药品库存管理

---

**完成时间**: 2025-12-17  
**版本**: v1.0
