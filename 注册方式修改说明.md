# 注册方式修改说明

## 修改概述

系统已将医生账号的申请流程改为在注册页面直接区分医生和患者,取消了原有的"普通用户申请成为医生"功能。

## 主要变更

### 1. 前端修改

#### 1.1 注册页面 (`fonted/pages/register/register.vue`)
- ✅ 添加用户类型选择器(患者/医生)
- ✅ 医生注册时显示专业信息填写表单:
  - 真实姓名 *
  - 身份证号
  - 职称 *
  - 科室 *
  - 擅长领域 *
  - 个人介绍
  - 执业证号 *
  - 执业证书照片 *
- ✅ 根据选择的角色动态验证必填字段
- ✅ 支持上传执业证书图片

#### 1.2 用户中心页面 (`fonted/pages/user/user.vue`)
- ✅ 注释了患者端的"申请成为医生"入口
- ✅ 注释了管理员端的"医生申请审核"功能入口
- ✅ 调整了管理员统计卡片显示

### 2. 后端修改

#### 2.1 API Handler (`backed/internal/api/handler/user_handler.go`)
- ✅ 注册接口扩展,支持接收用户角色参数(`role`)
- ✅ 新增医生专属字段接收:
  - realName (真实姓名)
  - idCard (身份证号)
  - doctorTitle (职称)
  - doctorDept (科室)
  - specialty (擅长领域)
  - introduction (个人介绍)
  - certNumber (执业证号)
  - certImage (执业证书)
- ✅ 根据角色调用不同的注册方法
- ✅ 医生注册时验证必填字段完整性

#### 2.2 Service Layer (`backed/internal/service/user_service.go`)
- ✅ 新增 `RegisterDoctor` 方法
- ✅ 医生注册时自动:
  - 设置角色为 `doctor`
  - 设置认证状态为 `approved`
  - SM4加密敏感信息(真实姓名、身份证、手机号、邮箱)
  - SM3哈希加密密码
- ✅ 医生注册后直接可用,无需审核

#### 2.3 路由配置 (`backed/internal/api/routes.go`)
- ✅ 注释了原有的医生申请接口:
  - `POST /api/user/apply-doctor`
  - `GET /api/user/doctor-application`
- ✅ 注释了管理员审核接口:
  - `PUT /api/user/admin/review-doctor`
  - `GET /api/user/admin/doctor-applications`

## 功能对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 注册流程 | 只能注册为患者 | 可选择患者或医生 |
| 医生认证 | 需要先注册患者,再申请成为医生,等待管理员审核 | 注册时直接填写医生信息,立即生效 |
| 管理员审核 | 需要审核医生申请 | 无需审核,医生直接注册生效 |
| 用户体验 | 需要2步操作+等待审核 | 1步完成,立即可用 |

## API 变更

### 注册接口 `POST /api/user/register`

**请求参数扩展:**

```json
{
  "username": "string (必填)",
  "password": "string (必填,SM3加密)",
  "email": "string (必填)",
  "phone": "string (必填)",
  "role": "patient | doctor (选填,默认patient)",
  
  // 以下为医生专属字段(role=doctor时必填)
  "realName": "string",
  "idCard": "string",
  "doctorTitle": "string",
  "doctorDept": "string",
  "specialty": "string",
  "introduction": "string",
  "certNumber": "string",
  "certImage": "string (证书图片URL)"
}
```

**返回参数:**

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 1001,
    "username": "doctor_zhang",
    "email": "zhang@example.com",
    "role": "doctor"
  }
}
```

## 废弃接口列表

以下接口已被注释,不再使用:

1. `POST /api/user/apply-doctor` - 申请成为医生
2. `GET /api/user/doctor-application` - 查询医生申请状态
3. `PUT /api/user/admin/review-doctor` - 管理员审核医生申请
4. `GET /api/user/admin/doctor-applications` - 获取医生申请列表

**注意:** 这些接口代码仍保留在系统中但已注释,如需恢复可取消注释。

## 数据库影响

- `SM_user` 表不受影响,仍然支持原有字段
- `SM_doctor_application` 表不再使用,但表结构保留

## 测试建议

### 患者注册测试
1. 打开注册页面
2. 选择"患者"类型
3. 填写基本信息(用户名、手机号、邮箱、密码)
4. 提交注册
5. 验证注册成功,角色为 `patient`

### 医生注册测试
1. 打开注册页面
2. 选择"医生"类型
3. 填写基本信息
4. 填写医生专业信息(姓名、职称、科室、擅长领域、执业证号)
5. 上传执业证书照片
6. 提交注册
7. 验证注册成功,角色为 `doctor`,认证状态为 `approved`
8. 使用医生账号登录,验证功能正常

### 回归测试
- ✅ 患者功能正常(问诊、病历查看等)
- ✅ 医生功能正常(接诊、开具病历等)
- ✅ 管理员功能正常(用户管理、日志查看等)
- ✅ 用户中心不再显示"申请成为医生"入口
- ✅ 管理员中心不再显示"医生申请审核"入口

## 注意事项

1. **向后兼容性**: 已注册的医生账号不受影响,继续正常使用
2. **待审核申请**: 如有待审核的医生申请,需要管理员手动处理或数据迁移
3. **证书上传**: 目前证书上传使用临时方案(base64),建议后续对接文件上传服务
4. **数据加密**: 医生敏感信息(姓名、身份证)已使用SM4加密存储

## 回滚方案

如需回滚到原有申请流程:

1. 取消 `routes.go` 中的接口注释
2. 取消 `user.vue` 中的功能入口注释
3. 修改注册页面,移除角色选择和医生字段
4. 注释 `RegisterDoctor` 方法调用

## 修改文件清单

### 前端文件
- `fonted/pages/register/register.vue` - 注册页面
- `fonted/pages/user/user.vue` - 用户中心页面

### 后端文件
- `backed/internal/api/handler/user_handler.go` - 用户处理器
- `backed/internal/service/user_service.go` - 用户服务
- `backed/internal/api/routes.go` - 路由配置

## 后续优化建议

1. **文件上传服务**: 完善执业证书上传功能,对接专业文件存储服务
2. **实名认证**: 对接第三方实名认证服务,验证医生身份真实性
3. **资质审核**: 如需要,可以添加医生资质后台审核机制
4. **角色转换**: 为特殊场景添加患者转医生的功能(需管理员操作)

---

**修改完成时间**: 2025-12-17  
**版本**: v2.0
