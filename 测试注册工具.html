<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·æ³¨å†Œæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: none;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ ç”¨æˆ·æ³¨å†Œæµ‹è¯•å·¥å…·</h1>
        
        <div class="info">
            <strong>è¯´æ˜ï¼š</strong><br>
            1. å¡«å†™æ³¨å†Œä¿¡æ¯ï¼Œç‚¹å‡»"ç”Ÿæˆæ³¨å†Œè¯·æ±‚"<br>
            2. å¯†ç ä¼šè‡ªåŠ¨ä½¿ç”¨SM3åŠ å¯†<br>
            3. å¤åˆ¶ç”Ÿæˆçš„curlå‘½ä»¤åœ¨ç»ˆç«¯æ‰§è¡Œï¼Œæˆ–ä½¿ç”¨"ç›´æ¥æ³¨å†Œ"æŒ‰é’®<br>
            4. åç«¯åœ°å€ï¼šhttp://localhost:3000
        </div>

        <form id="registerForm">
            <div class="form-group">
                <label for="username">ç”¨æˆ·å *</label>
                <input type="text" id="username" placeholder="4-20ä¸ªå­—ç¬¦" required>
            </div>
            
            <div class="form-group">
                <label for="password">å¯†ç  *</label>
                <input type="password" id="password" placeholder="8-20ä½ï¼Œå«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦" required>
            </div>
            
            <div class="form-group">
                <label for="email">é‚®ç®± *</label>
                <input type="email" id="email" placeholder="example@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="phone">æ‰‹æœºå· *</label>
                <input type="tel" id="phone" placeholder="13800138000" required>
            </div>

            <button type="button" onclick="generateCurl()">ç”Ÿæˆæ³¨å†Œè¯·æ±‚</button>
            <button type="button" onclick="directRegister()" style="background-color: #2196F3;">ç›´æ¥æ³¨å†Œåˆ°åç«¯</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        // SM3ç®—æ³•å®ç°ï¼ˆä¸å‰ç«¯crypto.jsä¿æŒä¸€è‡´ï¼‰
        function sm3(str) {
            const msg = typeof str === 'string' ? stringToBytes(str) : str
            const m = preprocess(msg)
            const n = m.length / 16
            
            let V = [
                0x7380166f, 0x4914b2b9, 0x172442d7, 0xda8a0600,
                0xa96f30bc, 0x163138aa, 0xe38dee4d, 0xb0fb0e4e
            ]
            
            for (let i = 0; i < n; i++) {
                const W = []
                const M = m.slice(i * 16, (i + 1) * 16)
                
                for (let j = 0; j < 16; j++) {
                    W[j] = M[j]
                }
                
                for (let j = 16; j < 68; j++) {
                    W[j] = P1(W[j - 16] ^ W[j - 9] ^ ROTL(W[j - 3], 15)) ^ ROTL(W[j - 13], 7) ^ W[j - 6]
                }
                
                const W1 = []
                for (let j = 0; j < 64; j++) {
                    W1[j] = W[j] ^ W[j + 4]
                }
                
                let [A, B, C, D, E, F, G, H] = V
                
                for (let j = 0; j < 64; j++) {
                    const SS1 = ROTL((ROTL(A, 12) + E + ROTL(T(j), j % 32)) & 0xffffffff, 7)
                    const SS2 = SS1 ^ ROTL(A, 12)
                    const TT1 = (FF(A, B, C, j) + D + SS2 + W1[j]) & 0xffffffff
                    const TT2 = (GG(E, F, G, j) + H + SS1 + W[j]) & 0xffffffff
                    
                    D = C
                    C = ROTL(B, 9)
                    B = A
                    A = TT1
                    H = G
                    G = ROTL(F, 19)
                    F = E
                    E = P0(TT2)
                }
                
                V = [
                    V[0] ^ A, V[1] ^ B, V[2] ^ C, V[3] ^ D,
                    V[4] ^ E, V[5] ^ F, V[6] ^ G, V[7] ^ H
                ]
            }
            
            return V.map(v => ('00000000' + v.toString(16)).slice(-8)).join('')
        }

        function stringToBytes(str) {
            const bytes = []
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i)
                if (code < 0x80) {
                    bytes.push(code)
                } else if (code < 0x800) {
                    bytes.push(0xc0 | (code >> 6), 0x80 | (code & 0x3f))
                } else if (code < 0x10000) {
                    bytes.push(0xe0 | (code >> 12), 0x80 | ((code >> 6) & 0x3f), 0x80 | (code & 0x3f))
                } else {
                    bytes.push(
                        0xf0 | (code >> 18),
                        0x80 | ((code >> 12) & 0x3f),
                        0x80 | ((code >> 6) & 0x3f),
                        0x80 | (code & 0x3f)
                    )
                }
            }
            return bytes
        }

        function preprocess(bytes) {
            const l = bytes.length * 8
            const k = (512 + 448 - (l + 1) % 512) % 512
            const len = (l + k + 65) / 32
            
            const m = new Array(len)
            for (let i = 0; i < len; i++) {
                m[i] = 0
            }
            
            for (let i = 0; i < bytes.length; i++) {
                m[i >> 2] |= bytes[i] << (24 - (i % 4) * 8)
            }
            
            m[bytes.length >> 2] |= 0x80 << (24 - (bytes.length % 4) * 8)
            m[len - 1] = l & 0xffffffff
            
            return m
        }

        function ROTL(x, n) {
            return ((x << n) | (x >>> (32 - n))) & 0xffffffff
        }

        function P0(x) {
            return x ^ ROTL(x, 9) ^ ROTL(x, 17)
        }

        function P1(x) {
            return x ^ ROTL(x, 15) ^ ROTL(x, 23)
        }

        function FF(x, y, z, j) {
            return j < 16 ? x ^ y ^ z : (x & y) | (x & z) | (y & z)
        }

        function GG(x, y, z, j) {
            return j < 16 ? x ^ y ^ z : (x & y) | (~x & z)
        }

        function T(j) {
            return j < 16 ? 0x79cc4519 : 0x7a879d8a
        }

        function encryptPassword(password) {
            return sm3(password)
        }

        function generateCurl() {
            const username = document.getElementById('username').value
            const password = document.getElementById('password').value
            const email = document.getElementById('email').value
            const phone = document.getElementById('phone').value

            if (!username || !password || !email || !phone) {
                showResult('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error')
                return
            }

            // SM3åŠ å¯†å¯†ç 
            const hashedPassword = encryptPassword(password)
            
            const curlCommand = `curl -X POST http://localhost:3000/api/user/register \\
  -H "Content-Type: application/json" \\
  -d '{
    "username": "${username}",
    "password": "${hashedPassword}",
    "email": "${email}",
    "phone": "${phone}",
    "verifyCode": "123456"
  }'`

            const resultHTML = `
                <h3>âœ… æ³¨å†Œè¯·æ±‚å·²ç”Ÿæˆ</h3>
                <p><strong>åŸå§‹å¯†ç ï¼š</strong>${password}</p>
                <p><strong>SM3åŠ å¯†åï¼š</strong>${hashedPassword}</p>
                <h4>æ–¹æ³•1ï¼šå¤åˆ¶ä»¥ä¸‹å‘½ä»¤åœ¨ç»ˆç«¯æ‰§è¡Œ</h4>
                <div class="code-block">${curlCommand}</div>
                <h4>æ–¹æ³•2ï¼šç‚¹å‡»ä¸Šæ–¹"ç›´æ¥æ³¨å†Œåˆ°åç«¯"æŒ‰é’®</h4>
            `
            
            showResult(resultHTML, 'success')
        }

        async function directRegister() {
            const username = document.getElementById('username').value
            const password = document.getElementById('password').value
            const email = document.getElementById('email').value
            const phone = document.getElementById('phone').value

            if (!username || !password || !email || !phone) {
                showResult('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error')
                return
            }

            // SM3åŠ å¯†å¯†ç 
            const hashedPassword = encryptPassword(password)
            
            try {
                const response = await fetch('http://localhost:3000/api/user/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: hashedPassword,
                        email: email,
                        phone: phone,
                        verifyCode: '123456'
                    })
                })

                const result = await response.json()
                
                if (response.ok && result.code === 200) {
                    const resultHTML = `
                        <h3>ğŸ‰ æ³¨å†ŒæˆåŠŸï¼</h3>
                        <p><strong>ç”¨æˆ·IDï¼š</strong>${result.data.userId}</p>
                        <p><strong>ç”¨æˆ·åï¼š</strong>${result.data.username}</p>
                        <p><strong>é‚®ç®±ï¼š</strong>${result.data.email}</p>
                        <p>ç°åœ¨å¯ä»¥ä½¿ç”¨è´¦å·ç™»å½•äº†ï¼</p>
                    `
                    showResult(resultHTML, 'success')
                } else {
                    showResult(`âŒ æ³¨å†Œå¤±è´¥ï¼š${result.message}`, 'error')
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}<br>è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆhttp://localhost:3000ï¼‰`, 'error')
            }
        }

        function showResult(html, type) {
            const resultDiv = document.getElementById('result')
            resultDiv.innerHTML = html
            resultDiv.className = 'result ' + type
            resultDiv.style.display = 'block'
        }
    </script>
</body>
</html>
