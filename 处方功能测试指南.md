# 处方功能测试步骤

## 一、数据库准备

### 1. 确认药品数据库已导入

在MySQL客户端或Navicat中执行:

```sql
USE SM;

-- 检查药品表
SELECT COUNT(*) as medicine_count FROM SM_medicine;
-- 应该返回 20 条记录(20种药品)

-- 查看部分药品数据
SELECT medicine_id, medicine_name, category, price FROM SM_medicine LIMIT 5;
```

### 2. 如果尚未导入,执行SQL脚本

```bash
# 在命令行中执行(替换为你的MySQL路径)
mysql -u root -p SM < database/medicine_database.sql
```

或者在Navicat/MySQL Workbench中:
- 打开 `database/medicine_database.sql` 文件
- 选择SM数据库
- 执行整个脚本

## 二、后端API测试

### 1. 启动后端服务

```bash
cd backed
go run cmd/main.go
```

确保后端服务运行在 http://localhost:3000

### 2. 测试药品搜索API

使用Postman或curl测试:

```bash
# 搜索所有药品
curl -X GET "http://localhost:3000/api/prescription/medicines/search?keyword=&category=&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 搜索感冒药
curl -X GET "http://localhost:3000/api/prescription/medicines/search?keyword=&category=感冒药&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 关键词搜索
curl -X GET "http://localhost:3000/api/prescription/medicines/search?keyword=999&category=&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 测试AI推荐药品API

```bash
curl -X POST "http://localhost:3000/api/prescription/medicines/recommend" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"aiDiagnosis": "患者出现发热、咳嗽症状，初步诊断为上呼吸道感染"}'
```

### 4. 测试完成问诊并开具处方

```bash
curl -X POST "http://localhost:3000/api/consultation/finish" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "consultationId": 1,
    "diagnosis": "上呼吸道感染",
    "prescription": [
      {
        "medicineId": 1,
        "quantity": 2,
        "usage": "口服",
        "frequency": "每日3次",
        "dosage": "1包",
        "duration": "7天",
        "notes": "饭后服用"
      }
    ]
  }'
```

### 5. 测试获取处方详情

```bash
curl -X GET "http://localhost:3000/api/prescription/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 三、前端功能测试

### 1. 启动前端项目

```bash
cd fonted
npm install  # 首次运行需要安装依赖
npm run dev
```

### 2. 测试流程

#### 2.1 医生登录
- 使用医生账号登录系统
- 进入"问诊"页面查看待接诊的问诊

#### 2.2 接诊问诊
- 点击某个待接诊的问诊
- 点击"接诊"按钮

#### 2.3 开具处方
- 在问诊详情页,点击底部的"+"按钮
- 选择"开具处方"
- 进入处方开具页面

#### 2.4 填写诊断和选择药品
- 填写诊断信息
- 如果有AI诊断,会显示AI推荐药品
- 可以点击推荐药品快速添加
- 也可以使用搜索功能查找药品
- 可以按分类筛选药品

#### 2.5 配置用药详情
- 为每个药品设置:
  - 用法(口服/外用等)
  - 频次(每日3次等)
  - 剂量(1片等)
  - 疗程(7天等)
  - 数量
  - 备注(可选)

#### 2.6 提交处方
- 确认药品清单和总金额
- 点击"开具处方"按钮
- 系统会自动完成问诊并创建处方

#### 2.7 查看处方
- 在病历详情中可以看到处方信息
- 点击处方卡片可以查看详细的处方内容

### 3. 患者端测试

#### 3.1 患者登录
- 使用患者账号登录
- 进入"问诊"页面

#### 3.2 查看已完成的问诊
- 找到医生已完成的问诊
- 进入问诊详情页

#### 3.3 查看处方
- 在聊天消息中会显示电子处方卡片
- 点击处方卡片查看详细内容
- 可以看到:
  - 处方编号
  - 医生和患者信息
  - 诊断结果
  - 药品清单及用药说明
  - 总金额
  - 数字签名验证

## 四、常见问题排查

### 1. 药品搜索返回空结果

检查:
```sql
-- 检查药品表是否有数据
SELECT COUNT(*) FROM SM_medicine;

-- 检查表结构
DESC SM_medicine;
```

### 2. 处方创建失败

检查:
```sql
-- 检查处方表是否存在
SHOW TABLES LIKE 'SM_prescription%';

-- 查看表结构
DESC SM_prescription;
DESC SM_prescription_detail;
```

### 3. API返回401未授权

- 确认已登录并获取token
- 检查请求头中是否包含正确的Authorization
- 检查token是否过期

### 4. 前端页面找不到

- 确认pages.json中已注册处方相关页面
- 检查路由路径是否正确
- 重新编译项目

## 五、预期结果

### 数据库层面
- SM_medicine表: 20条药品数据
- SM_prescription表: 开具处方后会新增记录
- SM_prescription_detail表: 每个处方的药品明细

### 后端API
- 搜索药品API返回药品列表
- AI推荐API返回相关类别的药品
- 完成问诊时可以同时创建处方
- 获取处方详情返回完整的处方信息

### 前端界面
- 医生可以在问诊中开具处方
- 药品搜索和分类筛选功能正常
- AI推荐药品正常显示
- 处方详情页面完整显示所有信息
- 患者可以查看医生开具的处方

## 六、功能特性

### 1. 国密加密
- 诊断信息使用SM4加密存储
- 处方数据使用SM3生成数字签名

### 2. AI智能推荐
- 根据AI诊断结果智能推荐相关药品
- 支持疾病关键词到药品分类的映射

### 3. 完整的用药说明
- 用法、频次、剂量、疗程
- 药品规格、单价、总价
- 特殊说明和注意事项

### 4. 数据完整性
- 处方编号自动生成
- 药品信息冗余存储
- 支持历史追溯
